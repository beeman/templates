name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '20 21 * * *' # 4:20 AM ICT (UTC+7)

permissions:
  contents: read

jobs:
  validate:
    name: Validate registry
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
      - name: Validate registry (create-seed@${{ vars.CREATE_SEED_TAG || 'latest' }})
        run: |
          TAG="${{ vars.CREATE_SEED_TAG || 'latest' }}"
          echo "Using create-seed@${TAG}"
          bun x create-seed@${TAG} registry validate

  setup-templates:
    name: Discover templates
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.matrix.outputs.templates }}
      ref: ${{ steps.ref.outputs.ref }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - id: ref
        run: |
          # For PRs use the head ref, otherwise use the branch name
          REF="${{ github.head_ref || github.ref_name }}"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Ref: $REF"
      - id: matrix
        run: |
          TEMPLATES=$(jq -c '[.templates[].path]' templates.json)
          echo "templates=$TEMPLATES" >> "$GITHUB_OUTPUT"
          echo "Templates: $TEMPLATES"

  test:
    name: "${{ matrix.template }} · node ${{ matrix.node }} · ${{ matrix.pm }}"
    runs-on: ubuntu-latest
    needs: [validate, setup-templates]
    if: needs.setup-templates.outputs.templates != '[]'
    strategy:
      fail-fast: false
      matrix:
        template: ${{ fromJson(needs.setup-templates.outputs.templates) }}
        node: [22, 24]
        pm: [bun, npx, pnpx]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ matrix.node }}

      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2

      - name: Install pnpm
        if: matrix.pm == 'pnpx'
        run: npm install -g pnpm

      - name: Scaffold project (create-seed@${{ vars.CREATE_SEED_TAG || 'latest' }})
        run: |
          REPO="${{ github.event.pull_request.head.repo.full_name || github.repository }}"
          REF="${{ needs.setup-templates.outputs.ref }}"
          TEMPLATE="gh:${REPO}/${{ matrix.template }}#${REF}"
          echo "Template: $TEMPLATE"

          TAG="${{ vars.CREATE_SEED_TAG || 'latest' }}"
          echo "Using create-seed@${TAG}"
          case "${{ matrix.pm }}" in
            bun)  CMD="bun x create-seed@${TAG}" ;;
            npx)  CMD="npx -y create-seed@${TAG}" ;;
            pnpx) CMD="pnpx create-seed@${TAG}" ;;
          esac
          $CMD test-project -t "$TEMPLATE"
        working-directory: ${{ runner.temp }}

      - name: CI
        run: bun run ci
        working-directory: ${{ runner.temp }}/test-project

      - name: Verify clean git
        run: |
          STATUS=$(git status --porcelain)
          if [ -n "$STATUS" ]; then
            echo "::error::Git is dirty after install + build:"
            echo "$STATUS"
            exit 1
          fi
        working-directory: ${{ runner.temp }}/test-project
